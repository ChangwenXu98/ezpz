#!/bin/bash --login

HOSTNAME=$(hostname)
PBS_ENV_FILE="${HOME}/.pbsenv"
COBALT_ENV_FILE="${HOME}/.cobaltenv"
SLURM_ENV_FILE="${HOME}/.slurmenv"

# function join_by { local d=${1-} f=${2-}; if shift 2; then printf %s "$f" "${@/#/$d}"; fi; }

function join_by {
    local d=${1-} f=${2-}
    if shift 2; then
        printf %s "$f" "${@/#/$d}"
    fi
}

function getPBSenv() {
    if [[ $(hostname) == x3* ]]; then
        export JOBENV_FILE="${PBS_ENV_FILE}"
        export DIST_LAUNCH="mpiexec --verbose --envall -n $NGPUS -ppn $NGPU_PER_HOST --hostfile $PBS_NODEFILE"
    else
        echo "Skipping getPBSenv() on $(hostname)"
    fi
}

function getCOBALTenv() {
    if [[ $(hostname) == thetagpu* ]]; then
        export JOBENV_FILE="${COBALT_ENV_FILE}"
        export DIST_LAUNCH="mpirun -n $NGPUS -N $NGPU_PER_HOST --hostfile $COBALT_NODEFILE -x PATH -x LD_LIBRARY_PATH"
    else
        echo "Skipping getCOBALTenv() on $(hostname)"
    fi
}

function getSLURMenv() {
    if [[ $(hostname) == nid* || $(hostname) == login* ]]; then
        export JOBENV_FILE="${SLURM_ENV_FILE}"
        export DIST_LAUNCH="srun --gpus ${NGPUS} --gpus-per-node ${NGPU_PER_HOST} -N ${NHOSTS} -n ${NGPUS} -l -u --verbose"
    else
        echo "Skipping getSLURMenv() on $(hostname)"
    fi
}

function getJOBenv() {
    if [[ $(hostname) == thetagpu* ]]; then
        getCOBALTenv
    elif [[ $(hostname) == x3* ]]; then
        getPBSenv
    elif [[ $(hostname) == nid* || $(hostname) == login* ]]; then
        getSLURMenv
    else
        echo "Unexpected hostname ${HOSTNAME}"
    fi
    source "${JOBENV_FILE}"
    alias launch="${DIST_LAUNCH}"
    export HOSTFILE="${HOSTFILE}"
    export NHOSTS="${NHOSTS}"
    export NGPU_PER_HOST="${NGPU_PER_HOST}"
    export NGPUS="${NGPUS}"
    HOSTS_ARR=$(cat "${HOSTFILE}")
    echo "┌──────────────────────────────────────────────────────────────────"  # ┐"
    echo "│ [Hosts]: "
    echo "│     • $(join_by ', ' $HOSTS_ARR)"
    echo "└──────────────────────────────────────────────────────────────────"  # ┘"
    echo "┌──────────────────────────────────────────────────────────────────"  # ┐"
    echo "│ [DIST INFO]: "
    echo "│     • Loading job env from: ${JOBENV_FILE}"
    echo "│     • Defining alias: $(which launch)"
    echo "│     • HOSTFILE: ${HOSTFILE}"
    echo "│     • NHOSTS: ${NHOSTS}"
    echo "│     • NGPU_PER_HOST: ${NGPU_PER_HOST}"
    echo "│     • NGPUS (NHOSTS x NGPU_PER_HOST): ${NGPUS}"
    echo "└──────────────────────────────────────────────────────────────────"  #┘"
}

getJOBenv
